#!/bin/bash
set -e
umask 022

source $BUILDROOT/opt/intel/sgxsdk/environment

if [[ ! -f "$SRCDIR/cocoon/CMakeLists.txt" ]]; then
  echo "No cocoon CMakeLists. Did you forget to git submodule update --init --recursive?"
  exit 1
fi

mkdir $SRCDIR/cocoon/build-reprodebian || true

(
  set -e
  export DESTDIR=
  mkosi-chroot --chdir $SRCDIR/cocoon/build-reprodebian cmake -DTON_ONLY_TONLIB=ON -DTON_USE_ROCKSDB=ON -DBUILD_SHARED_LIBS=OFF -DCMAKE_BUILD_TYPE=RelWithDebInfo -DTON_ARCH=x86-64-v3 -DCOCOON_ARCH=x86-64-v3 ..
  mkosi-chroot --chdir $SRCDIR/cocoon/build-reprodebian make -j $(nproc) cocoon-all health-monitor health-client
)

# Install binaries to guest image
mkdir -p "$DESTDIR/usr/bin"

for binary in tee/sgx-enclave/seal-client tee/sgx-enclave/seal-server tee/gen-cert tee/router worker-runner client-runner proxy-runner sync-time tee/cocoon-subst tee/health-monitor tee/health-client; do
  cp "$SRCDIR/cocoon/build-reprodebian/$binary" "$DESTDIR/usr/bin/"
done

# Install enclave.signed.so
cp "$SRCDIR/cocoon/build-reprodebian/tee/sgx-enclave/enclave.signed.so" "$DESTDIR/usr/bin/"

# Install MR_ENCLAVE
mkdir -p "$DESTDIR/usr/share/cocoon"
cp "$SRCDIR/cocoon/build-reprodebian/tee/sgx-enclave/mr_enclave.txt" "$DESTDIR/usr/share/cocoon/"

for binary in cocoon-init cocoon-prepare-spec cocoon-render-config cocoon-render-ton-config cocoon-sync-time gen-cert-synced; do
  cp "$SRCDIR/cocoon-init/$binary" "$DESTDIR/usr/bin/$binary"
done

mkdir -p "$DESTDIR/lib/systemd/system"
for service in cocoon-init.service cocoon-ready.target mnt-spec.mount spec.service cocoon-cert-refresh.service cocoon-cert-refresh.timer cocoon-health.service; do
  cp "$SRCDIR/cocoon-init/$service" "$DESTDIR/lib/systemd/system/$service"
done

mkdir -p "$DESTDIR/etc/systemd/system/docker.service.d"
cp "$SRCDIR/cocoon-init/cocoon-docker.conf" "$DESTDIR/etc/systemd/system/docker.service.d/cocoon-docker.conf"
mkdir -p "$DESTDIR/etc/docker"
cp "$SRCDIR/cocoon-init/docker-daemon.json" "$DESTDIR/etc/docker/daemon.json"

(
  cd $SRCDIR/pkg-cache
  rm -r fuse-archive-1.16 || true
  tar -xzf $SRCDIR/pkg-cache/fuse-archive-v1.16.tar.gz
  patch -d fuse-archive-1.16 -p1 < $SRCDIR/pkg-aux/fuse-archive-blockdev.patch
  mkosi-chroot --chdir "$SRCDIR/pkg-cache/fuse-archive-1.16" make install
)
